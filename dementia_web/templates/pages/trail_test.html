{% extends "base.html" %}
{% load static %}

{% block title %}Trail Making Test B{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/trail_test.css' %}">
<style>
.trail-container { max-width: 800px; margin: auto; padding: 20px; }
.trail-header { text-align: center; margin-bottom: 20px; }
.trail-board { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.trail-item { width: 60px; height: 60px; background: #eee; display:flex; align-items:center; justify-content:center; font-weight:bold; border-radius:6px; cursor:pointer; user-select:none; }
.trail-item.correct { background: #4caf50; color: white; }
.trail-item.wrong { background: #f44336; color: white; }
.trail-footer { text-align: center; margin-top: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="trail-container">
    <div class="trail-header">
        <h1>Trail Making Test B</h1>
        <p>Click numbers and letters in alternating order as fast as possible.</p>
        <p>Example: 1 → A → 2 → B → 3 → C …</p>
    </div>

    <div class="trail-board" id="trailBoard">
        <!-- Items generated by JS -->
    </div>

    <div class="trail-footer">
        <p>Time: <span id="timeElapsed">0.0</span> sec</p>
        <p>Mistakes: <span id="mistakes">0</span></p>
        <button id="submitBtn" class="btn btn-primary" disabled>Submit Score</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {

    const sequence = [
        "1","A","2","B","3","C","4","D","5","E","6","F","7","G","8","H","9","I"
    ]; // Trail B sequence
    let currentIndex = 0;
    let mistakes = 0;
    let startTime = null;

    const board = document.getElementById("trailBoard");
    const timeEl = document.getElementById("timeElapsed");
    const mistakesEl = document.getElementById("mistakes");
    const submitBtn = document.getElementById("submitBtn");

    // Shuffle and render items
    const shuffled = [...sequence].sort(() => Math.random() - 0.5);

    shuffled.forEach((val, idx) => {
        const div = document.createElement("div");
        div.className = "trail-item";
        div.textContent = val;
        div.addEventListener("click", () => handleClick(div, val));
        board.appendChild(div);
    });

    function handleClick(div, val) {
        if (!startTime) startTime = new Date().getTime();

        if (val === sequence[currentIndex]) {
            div.classList.add("correct");
            currentIndex++;
            if (currentIndex === sequence.length) {
                finishTest();
            }
        } else {
            div.classList.add("wrong");
            mistakes++;
            mistakesEl.textContent = mistakes;
        }
    }

    function finishTest() {
        const endTime = new Date().getTime();
        const timeTaken = ((endTime - startTime)/1000).toFixed(2);
        timeEl.textContent = timeTaken;
        submitBtn.disabled = false;

        submitBtn.addEventListener("click", () => {
            fetch("{% url 'submit_trail_b_score' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    time_taken: parseFloat(timeTaken),
                    mistakes: mistakes
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Score submitted successfully!");
                    window.location.href = "{% url 'take_test' %}";
                } else {
                    alert("Error submitting score.");
                }
            })
        });
    }

    // Timer update
    setInterval(() => {
        if (startTime && currentIndex < sequence.length) {
            const elapsed = ((new Date().getTime() - startTime)/1000).toFixed(1);
            timeEl.textContent = elapsed;
        }
    }, 100);
});
</script>
{% endblock %}
