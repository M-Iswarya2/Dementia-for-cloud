{% extends 'base.html' %}
{% load static %}

{% block title %}Attention & Reaction Test{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/attention_test.css' %}">
<style>
  /* Override any base.html wrapper centering */
  main, .main-content, .content-wrapper, #main, #content {
    align-items: flex-start !important;
    justify-content: flex-start !important;
  }

  #stimulus {
    position: fixed;
    font-size: 3rem;
    cursor: pointer;
    user-select: none;
    z-index: 10;
  }

  .trial-info {
    position: fixed;
    top: 20px;
    right: 30px;
    font-size: 1rem;
    z-index: 20;
  }
</style>
{% endblock %}

{% block content %}
<div class="attention-test-container">
  <h1>Attention & Reaction Test</h1>
  <p>Click the ball ONLY when it is <strong id="target-display"></strong></p>

  <button id="startBtn">Start Test</button>

  <div id="game" class="hidden">
    <div id="stimulus"></div>
    <p class="trial-info">Trial <span id="currentTrial">0</span> / <span id="totalTrials">0</span></p>
  </div>

  <div id="loading" class="hidden">
    <p>Submitting results...</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  let sessionId = null;
  let sequence = [];
  let targets = [];
  let currentIndex = -1;
  let stimulusStart = 0;
  let responses = [];

  const stimulusEl = document.getElementById("stimulus");
  const startBtn = document.getElementById("startBtn");
  const gameDiv = document.getElementById("game");
  const loadingDiv = document.getElementById("loading");
  const targetDisplay = document.getElementById("target-display");

  // Avoid overlapping with header/instructions/trial-info
  function randomizePosition() {
    const pad = 80;
    const ballSize = stimulusEl.offsetWidth;
    const avoidEls = [
        document.querySelector(".attention-test-container h1"),
        document.querySelector(".attention-test-container > p"),
        document.querySelector(".trial-info")
    ];

    let x, y, tries = 0;
    do {
        x = pad + Math.random() * (window.innerWidth - pad * 2 - ballSize);
        y = pad + Math.random() * (window.innerHeight - pad * 2 - ballSize);

        var overlaps = avoidEls.some(el => {
            const rect = el.getBoundingClientRect();
            return !(x + ballSize < rect.left || x > rect.right || y + ballSize < rect.top || y > rect.bottom);
        });

        tries++;
        if (tries > 50) break;
    } while (overlaps);

    stimulusEl.style.left = x + "px";
    stimulusEl.style.top = y + "px";
  }

  function handleClick() {
    if (currentIndex < 0 || currentIndex >= sequence.length) return;
    const reactionTime = (performance.now() - stimulusStart)/1000;

    if (sequence[currentIndex] === targets[currentIndex]) {
        responses.push({ index: currentIndex, reaction_time: Number(reactionTime.toFixed(3)) });
    }

    stimulusEl.style.transform = "scale(0.8)";
    setTimeout(() => { stimulusEl.style.transform = "scale(1)"; }, 100);
  }

  stimulusEl.addEventListener("click", handleClick);

  startBtn.onclick = async () => {
    startBtn.disabled = true;
    startBtn.textContent = "Loading...";

    try {
      const res = await fetch("{% url 'attention_start' %}", { method: "POST", headers: {"Content-Type": "application/json"} });
      const data = await res.json();

      sessionId = data.session_id;
      sequence = data.sequence;
      targets = data.targets;
      document.getElementById("totalTrials").textContent = data.total_trials;

      startBtn.classList.add("hidden");
      gameDiv.classList.remove("hidden");

      setTimeout(runSequence, 1000);

    } catch (err) {
      console.error(err);
      alert("Failed to start test.");
      startBtn.disabled = false;
      startBtn.textContent = "Start Test";
    }
  };

  function runSequence() {
    currentIndex = -1;

    function nextTrial() {
      currentIndex++;
      if (currentIndex >= sequence.length) {
        stimulusEl.style.display = "none";
        submitResults();
        return;
      }

      document.getElementById("currentTrial").textContent = currentIndex + 1;

      // Update instruction for current trial
      targetDisplay.textContent = targets[currentIndex];

      // Show ball stimulus
      stimulusEl.innerText = sequence[currentIndex];
      randomizePosition();
      stimulusEl.style.display = "block";
      stimulusStart = performance.now();

      // Hide after 2s, next trial after 0.5s
      setTimeout(() => {
        stimulusEl.style.display = "none";
        setTimeout(nextTrial, 500);
      }, 2000);
    }

    nextTrial();
  }

  async function submitResults() {
    gameDiv.classList.add("hidden");
    loadingDiv.classList.remove("hidden");

    try {
      const res = await fetch("{% url 'attention_submit' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ session_id: sessionId, responses: responses })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error || "Error");

      sessionStorage.setItem("attentionScore", data.attention_score || 0);

      await fetch("{% url 'submit_attention_score' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ score: data.attention_score || 0 })
      });

      window.location.href = "{% url 'take_test' %}";

    } catch (err) {
      console.error(err);
      loadingDiv.innerHTML = "<p style='color: red;'>Error submitting results. Try again.</p>";
    }
  }

});
</script>
{% endblock %}