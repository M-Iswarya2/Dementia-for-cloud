{% extends 'base.html' %}
{% load static %}

{% block title %}Voice Test - DementiaAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/voicetest.css' %}">
{% endblock %}

{% block content %}
<div class="voicetest-container">
    <div class="voicetest-card">
        <h2>Voice Analysis Test</h2>

        <div class="progress-bar">
            <div class="progress-fill" style="width: 100%;"></div>
        </div>
        <p class="step-text">Step 3 of 3</p>

        <div class="voicetest-content">
            <div class="instruction-box">
                <h3>Instructions:</h3>
                <ul>
                    <li>Record or upload your voice</li>
                    <li>Describe the image shown below</li>
                    <li><b>Duration must be between 30 and 60 seconds</b></li>
                </ul>
            </div>

            <div class="image-prompt">
                <h3>Describe this image:</h3>
                <div class="prompt-image-box">
                    <img src="{% static 'images/cookie_theft.jpg' %}">
                    <p class="image-caption">The Cookie Theft Picture</p>
                </div>
            </div>

            <div class="recording-section">
                <h3>Record or Upload Voice</h3>

                <div class="recording-controls">

                    <!-- MIC RECORD -->
                    <div class="record-option">
                        <button id="recordBtn" class="btn btn-primary">üéô Start Recording</button>
                        <button id="stopBtn" class="btn btn-secondary" disabled>‚èπ Stop</button>
                        <p class="upload-hint">Minimum 30 sec, Maximum 60 sec</p>
                    </div>

                    <!-- UPLOAD -->
                    <div class="upload-option">
                        <label for="audioFileInput" class="upload-label">üìÅ Upload Audio</label>
                        <input type="file" id="audioFileInput" accept="audio/*" hidden>
                    </div>

                    <!-- TIMER -->
                    <div id="timer" class="timer-display" style="display:none;">00:00</div>

                    <!-- STATUS -->
                    <div class="recording-status">
                        <span id="statusText">Ready</span>
                    </div>

                    <!-- PREVIEW -->
                    <div id="audioPreview" class="audio-preview">
                        <audio id="audioPlayback" controls></audio>
                    </div>

                    <!-- ACTIONS -->
                    <div id="actionButtons" class="action-buttons" style="display:none;">
                        <button id="retryBtn" class="btn btn-secondary">Retry</button>
                        <button id="submitBtn" class="btn btn-primary">Submit</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ================= CONFIG ================= */
const MIN_DURATION = 30;
const MAX_DURATION = 60;

/* ================= GLOBALS ================= */
let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;
let seconds = 0;
let timerInterval;

/* ================= ELEMENTS ================= */
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const timer = document.getElementById('timer');
const statusText = document.getElementById('statusText');
const audioPreview = document.getElementById('audioPreview');
const audioPlayback = document.getElementById('audioPlayback');
const actionButtons = document.getElementById('actionButtons');
const retryBtn = document.getElementById('retryBtn');
const submitBtn = document.getElementById('submitBtn');
const audioFileInput = document.getElementById('audioFileInput');

/* ================= TIMER ================= */
function updateTimer() {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    timer.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    timer.style.display = 'block';
}

/* ================= WAV ================= */
async function convertToWav(blob) {
    const ctx = new AudioContext();
    const buffer = await ctx.decodeAudioData(await blob.arrayBuffer());
    return audioBufferToWav(buffer);
}

function audioBufferToWav(buffer) {
    const samples = buffer.getChannelData(0);
    const wav = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(wav);

    write(view, 0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    write(view, 8, 'WAVE');
    write(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, buffer.sampleRate, true);
    view.setUint32(28, buffer.sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    write(view, 36, 'data');
    view.setUint32(40, samples.length * 2, true);

    let offset = 44;
    for (let i = 0; i < samples.length; i++, offset += 2) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
    }
    return new Blob([view], { type: 'audio/wav' });
}

function write(view, offset, text) {
    for (let i = 0; i < text.length; i++)
        view.setUint8(offset + i, text.charCodeAt(i));
}

/* ================= VALIDATION ================= */
function validDuration() {
    if (seconds < MIN_DURATION) {
        alert("‚ùå Minimum 30 seconds required");
        return false;
    }
    if (seconds > MAX_DURATION) {
        alert("‚ùå Maximum 60 seconds allowed");
        return false;
    }
    return true;
}

/* ================= MIC RECORD ================= */
recordBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    seconds = 0;

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
        if (!validDuration()) return resetAll();
        recordedBlob = await convertToWav(new Blob(audioChunks));
        audioPlayback.src = URL.createObjectURL(recordedBlob);
        audioPreview.style.display = 'block';
        actionButtons.style.display = 'flex';
        statusText.textContent = "Recording ready";
    };

    mediaRecorder.start();
    statusText.textContent = "Recording...";
    recordBtn.disabled = true;
    stopBtn.disabled = false;

    timerInterval = setInterval(() => {
        seconds++;
        updateTimer();
        if (seconds >= MAX_DURATION) stopBtn.click();
    }, 1000);
};

stopBtn.onclick = () => {
    mediaRecorder.stop();
    clearInterval(timerInterval);
    recordBtn.disabled = false;
    stopBtn.disabled = true;
};

/* ================= UPLOAD ================= */
audioFileInput.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;

    const ctx = new AudioContext();
    const buf = await ctx.decodeAudioData(await file.arrayBuffer());
    seconds = Math.floor(buf.duration);
    updateTimer();

    if (!validDuration()) return resetAll();

    recordedBlob = await convertToWav(file);
    audioPlayback.src = URL.createObjectURL(recordedBlob);
    audioPreview.style.display = 'block';
    actionButtons.style.display = 'flex';
};

/* ================= RESET ================= */
function resetAll() {
    recordedBlob = null;
    seconds = 0;
    timer.style.display = 'none';
    audioPreview.style.display = 'none';
    actionButtons.style.display = 'none';
    statusText.textContent = "Ready";
}

/* ================= SUBMIT ================= */
submitBtn.onclick = async () => {
    if (!recordedBlob) {
        alert("Please record or upload audio first.");
        return;
    }

    const audioFile = new File([recordedBlob], 'recording.wav', { type: 'audio/wav' });
    const fd = new FormData();
    fd.append('audio', audioFile);

    try {
        const res = await fetch('http://127.0.0.1:5000/voice/analyze', {
            method: 'POST',
            body: fd
        });

        const data = await res.json();

        // Save score in sessionStorage (optional)
        sessionStorage.setItem('voiceScore', data.voice_score);

        // Submit to Django backend
        const csrfToken = "{{ csrf_token }}";

        await fetch("{% url 'submit_voice_score' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ score: data.voice_score })
        });

        // Redirect to Take Test hub
        window.location.href = "{% url 'take_test' %}";

    } catch (err) {
        console.error(err);
        alert("Voice test submission failed. Try again.");
    }
};

retryBtn.onclick = resetAll;
</script>
{% endblock %}
